{% extends "base.html" %}
{% block content %}
  <div class="section-header">
    <h2>Application Logs</h2>
    <div class="log-controls">
      <input
        type="text"
        id="filter-input"
        class="filter-input"
        placeholder="Filter logs…"
        title="Type to filter log lines"
      />
      <select id="limit-select" title="Rows to show" style="margin-left:10px;">
        <option value="250">250</option>
        <option value="500" selected>500</option>
        <option value="750">750</option>
        <option value="1000">1000</option>
      </select>
      <button id="clear-btn" class="clear-button" style="margin-left:10px;">Clear Logs</button>
    </div>
  </div>

  <div class="logs" id="log-container"></div>
  <button id="load-more-btn" class="clear-button" style="display:none; margin:10px auto;">
    Load more…
  </button>

  <script>
    const container    = document.getElementById("log-container");
    const clearBtn     = document.getElementById("clear-btn");
    const filterInput  = document.getElementById("filter-input");
    const limitSelect  = document.getElementById("limit-select");
    const loadMoreBtn  = document.getElementById("load-more-btn");
    const protocol     = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl        = `${protocol}://${window.location.host}/api/v1/logs/websocket_logs`;
    const apiLogs      = "/api/v1/logs/get_logs";
    const apiClear     = "/api/v1/logs/clear_logs";

    let filterText   = "";
    let limitStep    = parseInt(limitSelect.value, 10);
    let loadedLimit  = limitStep;  // initial batch size
    let totalLines   = 0;

    // Append a log line if it matches the current filter
    function appendLine(line) {
      if (filterText && !line.toLowerCase().includes(filterText)) return;
      const div = document.createElement("div");
      div.className = "log-entry";
      div.textContent = line;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    // Load and display logs
    function loadLogs() {
      fetch(`${apiLogs}?limit=${loadedLimit}`)
        .then(r => r.json())
        .then(j => {
          totalLines = j.total ?? j.logs.length;
          container.innerHTML = "";
          j.logs.forEach(appendLine);
          loadMoreBtn.style.display = totalLines > loadedLimit ? "block" : "none";
          if (loadMoreBtn.style.display === "block") {
            loadMoreBtn.textContent = `Load ${limitStep} more…`;
          }
        })
        .catch(err => console.error("Failed to load logs:", err));
    }

    // Filter logs input
    filterInput.addEventListener("input", () => {
      filterText = filterInput.value.trim().toLowerCase();
      if (filterText) {
        document.querySelectorAll(".log-entry").forEach(div => {
          const text = div.textContent.toLowerCase();
          div.style.display = text.includes(filterText) ? "" : "none";
        });
      } else {
        loadLogs();
      }
    });

    // Change rows-to-show
    limitSelect.addEventListener("change", () => {
      limitStep = parseInt(limitSelect.value, 10);
      loadedLimit = limitStep;
      loadLogs();
    });

    // Load more on button click
    loadMoreBtn.addEventListener("click", () => {
      loadedLimit += limitStep;
      loadMoreBtn.style.display = "none";
      loadLogs();
    });

    // Clear logs
    clearBtn.addEventListener("click", async () => {
      clearBtn.disabled = true;
      try {
        const res = await fetch(apiClear, { method: "POST" });
        const j   = await res.json();
        if (res.ok && j.status === "cleared") {
          loadedLimit = limitStep;
          container.innerHTML = "";
        }
      } catch(err) {
        console.error("Error clearing logs:", err);
      } finally {
        clearBtn.disabled = false;
      }
    });

    // Initial load
    loadLogs();

    // WebSocket for live stream
    const ws = new WebSocket(wsUrl);
    ws.onmessage = evt => appendLine(evt.data);
    ws.onclose   = () => appendLine("--- live log stream closed ---");
    ws.onerror   = e   => console.error("WS error:", e);
  </script>
{% endblock %}
